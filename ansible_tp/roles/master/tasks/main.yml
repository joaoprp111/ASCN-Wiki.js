---

- name: Initialize the Kubernetes cluster using kubeadm
  command: kubeadm init --pod-network-cidr="{{ network }}" --apiserver-advertise-address="{{ master_ip }}"

- name: Create a directory for the Kubernetes cluster
  command: "{{ item }}"
  with_items:
    - mkdir -p $HOME/.kube
    - cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
    - chown $(id -u):$(id -g) $HOME/.kube/config

- name: Remove port
  lineinfile:
    path: /etc/kubernetes/manifests/kube-scheduler.yaml
    # String to Search
    regexp: "- --port=0" 
    # State is set to Absent to remove if the Searching Line is found
    state: absent

- name: Restart kubelet service
  command: systemctl restart kubelet.service

- name: Deploy flannel network
  command: kubectl apply -f kube-flannel.yaml

- name: Generate kube join command
  command: kubeadm token create --print-join-command
  register: join_command

- name: Copy join command to local file
  local_action: copy content="{{ join_command.stdout_lines[0] }}" dest="./join-command"